name: Trigger Claude Code Session

on:
  schedule:
    # CET candidates (winter) - Monday to Wednesday, Friday to Sunday (excluding Thursday)
    - cron: "0 4 * * 0-3,5-6" # 05:00 Norway (CET)
    - cron: "0 9 * * 0-3,5-6" # 10:00 Norway (CET)
    - cron: "0 14 * * 0-3,5-6" # 15:00 Norway (CET)

    # CEST candidates (summer) - Monday to Wednesday, Friday to Sunday (excluding Thursday)
    - cron: "0 3 * * 0-3,5-6" # 05:00 Norway (CEST)
    - cron: "0 8 * * 0-3,5-6" # 10:00 Norway (CEST)
    - cron: "0 13 * * 0-3,5-6" # 15:00 Norway (CEST)

    # Thursday early reset (09:00 Norway time) - ONLY trigger on Thursday
    - cron: "0 8 * * 4" # 09:00 Norway (CET) - Thursday
    - cron: "0 7 * * 4" # 09:00 Norway (CEST) - Thursday

  workflow_dispatch:

jobs:
  trigger:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Decide if this run should execute (CET vs CEST)
        id: dst-check
        shell: bash
        run: |
          set -e

          # For manual triggers, always run
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "============================================"
            echo "üöÄ Manual Trigger Detected"
            echo "============================================"
            echo "This is a manual workflow dispatch."
            echo "Skipping DST check and allowing execution."
            echo "============================================"
            echo ""
            
            echo "run=true" >> "$GITHUB_OUTPUT"
            echo "season=Manual Trigger" >> "$GITHUB_OUTPUT"
            echo "reason=Manually triggered - DST check bypassed" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # For scheduled runs, check DST
          echo "============================================"
          echo "üïê DST Check for Norway (Europe/Oslo)"
          echo "============================================"

          # Current UTC hour (00‚Äì23)
          UTC_HOUR=$(date -u +%H)
          UTC_DATETIME=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
          DAY_OF_WEEK=$(TZ=Europe/Oslo date +%u) # 1=Monday, 4=Thursday, 7=Sunday

          # Timezone offset for Europe/Oslo (+1 or +2)
          OSLO_OFFSET=$(TZ=Europe/Oslo date +%z)
          OSLO_DATETIME=$(TZ=Europe/Oslo date '+%Y-%m-%d %H:%M:%S %Z')

          echo "üìÖ Current UTC time: $UTC_DATETIME"
          echo "üìÖ Current Oslo time: $OSLO_DATETIME"
          echo "üåç Oslo timezone offset: $OSLO_OFFSET"
          echo "‚è∞ UTC hour: $UTC_HOUR"
          echo "üìÜ Day of week (Oslo): $DAY_OF_WEEK (4=Thursday)"
          echo ""

          RUN=false
          SEASON=""
          REASON=""

          if [[ "$OSLO_OFFSET" == "+0100" ]]; then
            # CET (winter)
            SEASON="CET (Winter)"
            if [[ "$DAY_OF_WEEK" == "4" ]]; then
              echo "üìÖ Thursday detected - ONLY running 09:00 Norway time trigger (UTC 08)"
              echo "‚ùÑÔ∏è  Currently in CET (Winter) - checking UTC hour 08 only"
              if [[ "$UTC_HOUR" == "08" ]]; then
                RUN=true
                REASON="UTC hour $UTC_HOUR matches Thursday 09:00 Norway time (CET) - early window reset"
              else
                REASON="UTC hour $UTC_HOUR does not match Thursday schedule (need 08 for 09:00 Norway time). Regular triggers (05:00, 10:00, 15:00) are disabled on Thursdays."
              fi
            else
              echo "‚ùÑÔ∏è  Currently in CET (Winter) - checking UTC hours 04, 09, 14"
              if [[ "$UTC_HOUR" == "04" || "$UTC_HOUR" == "09" || "$UTC_HOUR" == "14" ]]; then
                RUN=true
                REASON="UTC hour $UTC_HOUR matches CET schedule (05:00, 10:00, or 15:00 Norway time)"
              else
                REASON="UTC hour $UTC_HOUR does not match CET schedule (need 04, 09, or 14)"
              fi
            fi
          elif [[ "$OSLO_OFFSET" == "+0200" ]]; then
            # CEST (summer)
            SEASON="CEST (Summer)"
            if [[ "$DAY_OF_WEEK" == "4" ]]; then
              echo "üìÖ Thursday detected - ONLY running 09:00 Norway time trigger (UTC 07)"
              echo "‚òÄÔ∏è  Currently in CEST (Summer) - checking UTC hour 07 only"
              if [[ "$UTC_HOUR" == "07" ]]; then
                RUN=true
                REASON="UTC hour $UTC_HOUR matches Thursday 09:00 Norway time (CEST) - early window reset"
              else
                REASON="UTC hour $UTC_HOUR does not match Thursday schedule (need 07 for 09:00 Norway time). Regular triggers (05:00, 10:00, 15:00) are disabled on Thursdays."
              fi
            else
              echo "‚òÄÔ∏è  Currently in CEST (Summer) - checking UTC hours 03, 08, 13"
              if [[ "$UTC_HOUR" == "03" || "$UTC_HOUR" == "08" || "$UTC_HOUR" == "13" ]]; then
                RUN=true
                REASON="UTC hour $UTC_HOUR matches CEST schedule (05:00, 10:00, or 15:00 Norway time)"
              else
                REASON="UTC hour $UTC_HOUR does not match CEST schedule (need 03, 08, or 13)"
              fi
            fi
          else
            REASON="Unexpected timezone offset: $OSLO_OFFSET"
          fi

          echo ""
          echo "============================================"
          if [[ "$RUN" == "true" ]]; then
            echo "‚úÖ DECISION: Will execute Claude session"
          else
            echo "‚è≠Ô∏è  DECISION: Will skip Claude session"
          fi
          echo "üìù Season: $SEASON"
          echo "üìù Reason: $REASON"
          echo "============================================"
          echo ""

          echo "run=$RUN" >> "$GITHUB_OUTPUT"
          echo "season=$SEASON" >> "$GITHUB_OUTPUT"
          echo "reason=$REASON" >> "$GITHUB_OUTPUT"

      - name: Skip if wrong season (scheduled runs only)
        if: steps.dst-check.outputs.run != 'true'
        run: |
          echo "‚è≠Ô∏è  Skipping Claude session execution"
          echo "Season: ${{ steps.dst-check.outputs.season }}"
          echo "Reason: ${{ steps.dst-check.outputs.reason }}"

      - name: Trigger Claude Code session
        if: steps.dst-check.outputs.run == 'true'
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: "hi, only answer hi"
          claude_args: '--allowed-tools "" --max-turns 1 --model claude-haiku-4-5'

      - name: Session Summary
        if: always()
        run: |
          echo "============================================"
          echo "üìä Workflow Execution Summary"
          echo "============================================"
          echo "Season: ${{ steps.dst-check.outputs.season || 'N/A' }}"
          echo "Decision: ${{ steps.dst-check.outputs.run == 'true' && '‚úÖ Executed' || '‚è≠Ô∏è  Skipped' }}"
          echo "Reason: ${{ steps.dst-check.outputs.reason || 'No reason provided' }}"
          echo "Trigger: ${{ github.event_name }}"
          echo "============================================"
